language: objective-c
env:
  matrix:
  - MONO_VERSION="3.4.0"
  global:
    - secure: "BlgjX4Szqo5ueziHsLep9wrURiWLpth1vsYO75YE63jWrS9pPnUdFJiB3wHWZf0D0a1R2EWAz9aRTOAFyHPLRmK7uQL8acmRoebpLYkHCdGaYsbWqaIvFLhYd4yqDCSV1JbU1DVJxLGXCZ1S39UNtznci+MuyFjy/RreciCWhQ8="
    - secure: "MbEXVzzpAhn4uQaZ7HL1OT/4pInWAtwjDQuaWyXZ7Kb5CE9LFStXfMn5meTc6i51SXNWf/yEvYhP+0PZW5z5V+GIjCSWl66yyUCdBV8caezDaURKBZZgRnsRlbFzDbey78mtbg8HOjCQQ+aWGXLoxG/7045irCWPaU+InO05IX8="
    - REPO="https://$OAUTH_TOKEN:x-oauth-basic@github.com/flickr-downloadr/flickr-downloadr.github.io.git"
before_install:
  # Mono Framework
  - wget "http://download.mono-project.com/archive/${MONO_VERSION}/macos-10-x86/MonoFramework-MDK-${MONO_VERSION}.macos10.xamarin.x86.pkg"
  - sudo installer -pkg "MonoFramework-MDK-${MONO_VERSION}.macos10.xamarin.x86.pkg" -target /
  # Bitrock Install Builder
  - wget "http://installbuilder.bitrock.com/installbuilder-enterprise-8.6.0-osx-installer.dmg"
  - hdiutil mount installbuilder-enterprise-8.6.0-osx-installer.dmg
  - sudo '/Volumes/InstallBuilder Multiplatform Enterprise 8.6.0/installbuilder-enterprise-8.6.0-osx-installer.app/Contents/MacOS/installbuilder.sh' --mode unattended --unattendedmodeui none
before_script:
  # Unpack ssh key for git
  - echo -n $id_rsa_{00..30} >> ~/.ssh/id_rsa_base64
  - base64 --decode ~/.ssh/id_rsa_base64 > ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - echo -n $id_rsa_pub_{00..10} >> ~/.ssh/id_rsa_base64_pub
  - base64 --decode ~/.ssh/id_rsa_base64_pub > ~/.ssh/id_rsa.pub
  - chmod 600 ~/.ssh/id_rsa.pub
  # Disable SSH server fingerprint verification
  - echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
script:
  - cd build-tools
  - ./go.sh travis Release
after_success:
  # Commit the new installers
  - cd .. && mkdir tmp-github.io && cd $_
  - git clone -b master $REPO
  - cd flickr-downloadr.github.io
  - git config push.default tracking
  - git checkout -b deploy-v${BUILDNUMBER}
  - cp -r ../../dist/* ./installer
  - cp ../../build-tools/build.number .
  - git add -f .
  - git commit -m "created release v${BUILDNUMBER}"
  - git push -u origin deploy-v${BUILDNUMBER}
